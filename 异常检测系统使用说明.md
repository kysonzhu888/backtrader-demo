# 异常检测系统使用说明

## 系统概述

本系统基于Redis缓存的历史数据，实现了独立的异常检测功能，包括开板、涨停、跌停、异常放量等多种异常情况的实时监控。

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MarketData    │    │   AlertDetector │    │   DashBoard     │
│   Service       │    │   (独立检测器)   │    │   (前端展示)     │
│                 │    │                 │    │                 │
│ - 数据采集      │    │ - 开板检测      │    │ - 实时监控      │
│ - Redis缓存     │    │ - 涨停检测      │    │ - 异常提示      │
│ - API接口       │    │ - 异常统计      │    │ - 股票筛选      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Redis Cache   │
                    │                 │
                    │ - 历史数据      │
                    │ - 最新数据      │
                    │ - 异常记录      │
                    └─────────────────┘
```

## 核心特性

### 1. 独立的异常检测器
- **不侵入MarketDataService**：检测器完全独立，不影响数据采集服务
- **基于Redis历史数据**：从Redis中读取股票的历史价格数据进行分析
- **实时检测**：每5秒检测一次所有股票的异常情况
- **智能交易时间检测**：只在交易时间内进行异常检测，避免无效提示

### 2. 多种异常类型
- **开板检测**：检测涨停后开板的情况
- **涨停/跌停**：检测价格达到涨跌停板
- **异常放量**：检测成交量异常放大
- **价格异动**：检测价格剧烈波动
- **突破新高**：检测突破当日新高

### 3. 智能去重
- **避免重复提示**：同一只股票的同一异常情况只提示一次
- **时间窗口控制**：可设置检测时间窗口

### 4. 多市场支持
- **主板**：涨停10%，跌停10%
- **创业板**：涨停20%，跌停20%
- **科创板**：涨停20%，跌停20%
- **北交所**：涨停30%，跌停30%

## 使用方法

### 1. 启动系统

```bash
# 方式1: 使用启动脚本
python start_alert_system.py

# 方式2: 分别启动各个组件
python market_data_service.py  # 启动数据服务
python trading_dashboard.py  # 启动仪表板
```

### 2. 访问界面

- **市场数据服务**: http://localhost:5000
- **Dash仪表板**: http://localhost:8051

### 3. API接口

#### 获取异常提示
```bash
# 获取最近30分钟的异常提示
GET http://localhost:5000/alerts/recent?minutes=30

# 获取指定类型的异常提示
GET http://localhost:5000/alerts/type/开板?minutes=30

# 获取异常统计
GET http://localhost:5000/alerts/stats
```

#### 响应格式
```json
{
  "stock_code": "000001.SZ",
  "alert_type": "开板",
  "level": "紧急",
  "message": "000001.SZ 开板！涨停持续 120秒，当前涨幅 8.50%",
  "data": {
    "change_pct": 0.085,
    "current_price": 10.85,
    "limit_up_duration": 120,
    "limit_up_time": "2025-01-20T10:30:00"
  },
  "timestamp": "2025-01-20T10:32:00"
}
```

## 配置参数

### 异常检测阈值
在 `alert_detector.py` 中可以调整以下参数：

```python
# 不同市场的涨停阈值（自动根据股票代码判断）
# 主板（000、001、002、600、601、603等）：10%
# 创业板（300、301）：20%
# 科创板（688）：20%
# 北交所（8开头）：30%

self.volume_surge_threshold = 3.0    # 成交量异动阈值（3倍）
self.price_surge_threshold = 0.05    # 价格异动阈值（5%）
self.breakout_threshold = 0.02       # 突破阈值（2%）
```

### 检测频率
```python
# 交易时间内每5秒检测一次
# 非交易时间每60秒检查一次（但不进行异常检测）
if TradingTimeUtils.is_trading_time():
    self._detect_all_alerts()
    time.sleep(5)
else:
    time.sleep(60)
```

## 测试验证

### 1. 运行测试脚本
```bash
# 测试涨停阈值
python test_limit_threshold.py

# 测试完整系统
python test_complete_system.py

# 测试Redis修复
python test_redis_fix.py
```

### 2. 检查日志
```bash
tail -f alert_system.log
```

### 3. 监控Redis数据
```bash
# 查看缓存统计
redis-cli keys "stock_latest:*"

# 查看异常记录
redis-cli keys "filter_cache:*"
```

## 开板检测逻辑

### 核心算法
1. **获取历史数据**：从Redis中读取股票当天的所有历史价格数据
2. **判断市场类型**：根据股票代码确定涨停阈值
3. **计算涨幅**：基于前收盘价计算每个时间点的涨幅
4. **检测涨停**：当涨幅 ≥ 对应阈值时标记为涨停状态
5. **检测开板**：当之前涨停过，但当前涨幅 < 对应阈值时触发开板提示
6. **计算持续时间**：计算涨停持续时间
7. **去重处理**：避免重复提示同一开板事件

### 市场涨停阈值
| 市场类型 | 股票代码前缀 | 涨停幅度 | 跌停幅度 |
|---------|-------------|---------|---------|
| 主板 | 000、001、002、600、601、603 | 10% | 10% |
| 创业板 | 300、301 | 20% | 20% |
| 科创板 | 688 | 20% | 20% |
| 北交所 | 8 | 30% | 30% |

### 示例场景
```
时间    价格    涨幅    状态
09:30   10.00   0.00%   正常
10:00   10.99   9.90%   涨停(10%)  ← 主板
10:30   10.99   9.90%   涨停(10%)
11:00   10.85   8.50%   开板！ ← 触发提示

时间    价格    涨幅    状态
09:30   10.00   0.00%   正常
10:00   11.99   19.90%  涨停(20%) ← 创业板
10:30   11.99   19.90%  涨停(20%)
11:00   11.85   18.50%  开板！ ← 触发提示
```

### 交易时间检测
系统只在交易时间内进行异常检测：

- **交易时间**：每5秒检测一次
- **非交易时间**：每60秒检查一次，但不进行异常检测
- **避免无效提示**：防止在非交易时间产生无意义的异常提示

## 性能优化

### 1. 批量处理
- 使用Redis管道批量获取数据
- 批量缓存异常记录

### 2. 内存管理
- 限制历史记录数量（默认1000条）
- 定时清理过期数据

### 3. 并发安全
- 使用线程锁保护共享数据
- 异步处理异常检测

## 故障排除

### 1. 没有异常提示
- 检查Redis连接是否正常
- 确认股票数据是否已缓存
- 查看检测器日志

### 2. 重复提示
- 检查去重逻辑是否正常
- 确认时间戳格式是否正确

### 3. 性能问题
- 调整检测频率
- 优化Redis查询
- 增加缓存过期时间

### 4. Redis相关错误

#### 4.1 'str' object has no attribute 'decode' 错误
**错误信息**: `ERROR - 批量获取股票最新数据失败: 'str' object has no attribute 'decode'`

**原因**: 在 `redis_cache_manager.py` 中设置了 `decode_responses=True`，Redis返回的已经是字符串，不需要再调用 `decode()` 方法。

**解决方案**: 已修复，将 `key.decode('utf-8').split(':', 1)[1]` 改为 `key.split(':', 1)[1]`

**验证方法**:
```bash
python test_redis_fix.py
```

#### 4.2 Redis连接失败
**错误信息**: `Redis连接失败: Connection refused`

**解决方案**:
1. 确认Redis服务是否启动
2. 检查Redis配置（host, port, password）
3. 验证网络连接

```bash
# 检查Redis服务状态
redis-cli ping

# 测试连接
python test_complete_system.py
```

#### 4.3 数据格式错误
**错误信息**: `JSONDecodeError` 或数据字段缺失

**解决方案**:
1. 检查Redis中的数据格式
2. 确认数据字段名称是否正确
3. 查看数据采集服务的日志

```bash
# 检查Redis数据格式
redis-cli get "stock_latest:000001.SZ"
```

### 5. 异常检测器问题

#### 5.1 检测器未启动
**症状**: 没有异常提示，日志显示检测器未启动

**解决方案**:
```python
from alert_detector import get_alert_detector
detector = get_alert_detector()
print("检测器状态:", detector.running)
```

#### 5.2 检测频率问题
**症状**: 异常提示延迟或过于频繁

**解决方案**: 调整检测频率
```python
# 在 alert_detector.py 中修改
time.sleep(5)  # 改为需要的秒数
```

### 6. 系统启动问题

#### 6.1 端口占用
**错误信息**: `Address already in use`

**解决方案**:
```bash
# 查找占用端口的进程
lsof -i :5000
lsof -i :8051

# 杀死进程
kill -9 <PID>
```

#### 6.2 依赖缺失
**错误信息**: `ModuleNotFoundError`

**解决方案**:
```bash
# 安装依赖
pip install redis dash pandas

# 检查环境
python -c "import redis, dash, pandas; print('依赖正常')"
```

### 7. 数据质量问题

#### 7.1 前收盘价缺失
**症状**: 无法计算涨幅，异常检测失效

**解决方案**:
1. 检查数据采集服务是否正常获取前收盘价
2. 确认股票代码格式是否正确
3. 查看数据源是否正常

#### 7.2 时间戳问题
**症状**: 时间计算错误，异常提示时间不准确

**解决方案**:
1. 确认系统时间是否正确
2. 检查时间戳格式是否统一
3. 验证时区设置

### 8. 性能优化建议

#### 8.1 内存优化
- 定期清理过期异常记录
- 限制历史数据存储量
- 监控内存使用情况

#### 8.2 检测优化
- 根据股票数量调整检测频率
- 使用批量操作减少Redis查询
- 实现增量检测避免重复计算

#### 8.3 日志优化
- 设置合适的日志级别
- 定期清理日志文件
- 使用结构化日志便于分析

### 9. 监控和告警

#### 9.1 系统监控
```bash
# 监控Redis内存使用
redis-cli info memory

# 监控异常检测器状态
tail -f alert_system.log | grep "ALERT"

# 监控系统资源
top -p $(pgrep -f "python.*alert")
```

#### 9.2 告警设置
- 设置Redis连接告警
- 监控异常检测器运行状态
- 设置磁盘空间告警

## 扩展功能

### 1. 添加新的异常类型
在 `AlertType` 枚举中添加新类型，并在 `_detect_other_alerts` 方法中实现检测逻辑。

### 2. 自定义检测规则
修改 `AlertDetector` 类中的阈值参数，或添加新的检测方法。

### 3. 通知功能
在 `_add_alert` 方法中添加邮件、短信等通知功能。

## 注意事项

1. **数据依赖**：异常检测依赖于Redis中的历史数据，确保数据服务正常运行
2. **时间同步**：确保系统时间准确，避免时间戳错误
3. **内存使用**：监控内存使用情况，避免内存泄漏
4. **日志管理**：定期清理日志文件，避免磁盘空间不足

## 更新日志

- **v1.0**: 初始版本，实现基础异常检测功能
- **v1.1**: 优化开板检测逻辑，增加去重机制
- **v1.2**: 重构为独立检测器，不侵入数据服务 